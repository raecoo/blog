
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>使用Postfix, Courier及MySql构建自已的邮件服务器 - Nothing Impossible</title>
  <meta name="author" content="Raecoo Cao">

  
  <meta name="description" content="本文将介绍如何在Ubuntu上运行Postfix邮件系统, 使用Courier提供IMAP/POP3(IMAPS and POP3S)服务, 并将虚拟域和用户数据保存于MySql中. 1. 安装必须的软件包 apt-get install postfix postfix-mysql postfix &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://raecoo.github.com/blog/2009/12/09/using-postfix-with-courier-and-mysql-on-debian/">
  <link href="/blog/favicon.png" rel="icon">
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <script src="/blog/javascripts/ender.js"></script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/blog/atom.xml" rel="alternate" title="Nothing Impossible" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/blog/">Nothing Impossible</a></h1>
  
    <h2>Focus on Web 2.0, Ruby on Rails, CoffeeScript, BDD … All of the Web Technologies.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/blog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:raecoo.github.com/blog" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/blog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">使用Postfix, Courier及MySql构建自已的邮件服务器</h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-12-09T00:00:00+08:00" pubdate data-updated="true">Dec 9<span>th</span>, 2009</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>本文将介绍如何在Ubuntu上运行Postfix邮件系统, 使用Courier提供IMAP/POP3(IMAPS and POP3S)服务, 并将虚拟域和用户数据保存于MySql中.</p>

<p><strong>1. 安装必须的软件包</strong></p>

<pre><code>apt-get install postfix postfix-mysql postfix-doc mysql-client mysql-server courier-authdaemon \
        courier-authlib-mysql courier-pop courier-pop-ssl courier-imap courier-imap-ssl \
        libsasl2-2 libsasl2-modules libsasl2-modules-sql sasl2-bin libpam-mysql openssl</code></pre>


<p>安装过程中需要输入MySql的root密码, 在选择邮件服务器类型时选择&#8221;Internet Site&#8221;, 在输入system mail name
时请输入一个完整的域名并指向服务器的IP地址.</p>

<!--more-->


<p><strong>2. 设置虚拟域及用户</strong></p>

<pre><code>$mysql -uroot -p
mysql>create database mail_system;
mysql>use mail_system;
mysql>GRANT ALL ON mail_system.* TO 'mail_admin'@'localhost' IDENTIFIED BY 'mail_admin_password';
mysql>FLUSH PRIVILEGES;</code></pre>


<p>创建虚拟域数据表</p>

<pre><code>mysql>CREATE TABLE domains (domain varchar(50) NOT NULL, PRIMARY KEY (domain) );</code></pre>


<p>创建虚拟用户数据表</p>

<pre><code>mysql>CREATE TABLE users (email varchar(80) NOT NULL, password varchar(20) NOT NULL,
  PRIMARY KEY (email) );</code></pre>


<p>创建邮件转发数据表(可选项)</p>

<pre><code>mysql>CREATE TABLE forwardings (source varchar(80) NOT NULL, destination TEXT NOT NULL,
  PRIMARY KEY (source) );</code></pre>


<p>创建Transport数据表(可选项)</p>

<pre><code>mysql>CREATE TABLE transport (domain varchar(128) NOT NULL default '', transport varchar(128) NOT NULL default '', UNIQUE KEY domain (domain));</code></pre>


<p>绑定MySql</p>

<pre><code>$vim /etc/mysql/my.cnf
bind-address = 127.0.0.1</code></pre>


<p>重启MySql</p>

<pre><code>$/etc/init.d/mysql restart</code></pre>


<p><strong>3. 设置Postfix使其支持MySql</strong></p>

<p>创建虚拟域配置文件</p>

<pre><code>$vim /etc/postfix/mysql-virtual_domains.cf
user = mail_admin
password = mail_admin_password
dbname = mail_system
query = SELECT domain AS virtual FROM domains WHERE domain='%s'
hosts = 127.0.0.1</code></pre>


<p>创建虚拟收件箱配置文件</p>

<pre><code>$vim /etc/postfix/mysql-virtual_mailboxes.cf
user = mail_admin
password = mail_admin_password
dbname = mail_system
query = SELECT CONCAT(SUBSTRING_INDEX(email,'@',-1),'/',SUBSTRING_INDEX(email,'@',1),'/')
        FROM users WHERE email='%s'
hosts = 127.0.0.1</code></pre>


<p>创建虚拟转发配置文件(可选项)</p>

<pre><code>$/etc/postfix/mysql-virtual_forwardings.cf
user = mail_admin
password = mail_admin_password
dbname = mail_system
query = SELECT destination FROM forwardings WHERE source='%s'
hosts = 127.0.0.1</code></pre>


<p>创建虚拟邮件关系配置文件(可选项)</p>

<pre><code>$vim /etc/postfix/mysql-virtual_email2email.cf
user = mail_admin
password = mail_admin_password
dbname = mail_system
query = SELECT email FROM users WHERE email='%s'
hosts = 127.0.0.1</code></pre>


<p>设置文件权限与属主信息</p>

<pre><code>$chmod o= /etc/postfix/mysql-virtual_*.cf
$chgrp postfix /etc/postfix/mysql-virtual_*.cf</code></pre>


<p>接下来, 创建用来处理邮件的用户和组, 所有邮件将保存于此用户的HOME目录,并以虚拟域独立保存</p>

<pre><code>$groupadd -g 5000 vmail
$useradd -g vmail -u 5000 vmail -d /home/vmail -m</code></pre>


<p>修改Postfix的配置文件如下:</p>

<pre><code>myhostname = mail.raecoo.com
mydestination = mail.raecoo.com, localhost, localhost.localdomain
message_size_limit = 30720000
virtual_alias_domains = 
virtual_alias_maps = proxy:mysql:/etc/postfix/mysql-virtual_forwardings.cf, mysql:/etc/postfix/mysql-virtual_email2email.cf
virtual_mailbox_domains = proxy:mysql:/etc/postfix/mysql-virtual_domains.cf
virtual_mailbox_maps = proxy:mysql:/etc/postfix/mysql-virtual_mailboxes.cf
virtual_mailbox_base = /home/vmail
virtual_uid_maps = static:5000
virtual_gid_maps = static:5000
smtpd_sasl_auth_enable = yes
broken_sasl_auth_clients = yes
smtpd_sasl_authenticated_header = yes
smtpd_recipient_restrictions = permit_mynetworks, permit_sasl_authenticated,reject_unauth_destination
smtpd_use_tls = yes
smtpd_tls_cert_file = /etc/postfix/smtpd.cert
smtpd_tls_key_file = /etc/postfix/smtpd.key
virtual_create_maildirsize = yes
virtual_maildir_extended = yes
proxy_read_maps = $local_recipient_maps $mydestination $virtual_alias_maps $virtual_alias_domains $virtual_mailbox_maps $virtual_mailbox_domains $relay_recipient_maps $relay_domains $canonical_maps $sender_canonical_maps $recipient_canonical_maps $relocated_maps $transport_maps $mynetworks $virtual_mailbox_limit_maps</code></pre>


<p><strong>为Postfix创建SSL证书</strong></p>

<pre><code>$ cd /etc/postfix
$openssl req -new -outform PEM -out smtpd.cert -newkey rsa:2048 -nodes -keyout smtpd.key
        -keyform PEM -days 365 -x509</code></pre>


<p>一路回车或是将信息填写完整, 再设置一下证书的权限</p>

<pre><code>$chmod o= /etc/postfix/smtpd.key</code></pre>


<p><strong>4. 设置Saslauthd服务使其支持MySql</strong></p>

<pre><code>$mkdir -p /var/spool/postfix/var/run/saslauthd
$vim /etc/default/saslauthd
#更改START和OPTIONS为如下所示
START=yes
OPTIONS="-c -m /var/spool/postfix/var/run/saslauthd -r"</code></pre>


<p>创建或编辑/etc/pam.d/smtp, 并添加如下内容(注意是auth和account共两行)</p>

<pre><code>auth    required   pam_mysql.so user=mail_admin passwd=mail_admin_password host=127.0.0.1
        db=mail table=users usercolumn=email passwdcolumn=password crypt=1
account sufficient pam_mysql.so user=mail_admin passwd=mail_admin_password host=127.0.0.1
        db=mail table=users usercolumn=email passwdcolumn=password crypt=1</code></pre>


<p>创建或编辑/etc/postfix/sasl/smtpd.conf</p>

<pre><code>$vim /etc/postfix/sasl/smtpd.conf
pwcheck_method: saslauthd
mech_list: plain login
allow_plaintext: true
auxprop_plugin: mysql
sql_hostnames: 127.0.0.1
sql_user: mail_admin
sql_passwd: mail_admin_password
sql_database: mail
sql_select: select password from users where email = '%u'</code></pre>


<p>添加Postfix用户至Sasl组并重启服务</p>

<pre><code>$/etc/init.d/postfix restart
$/etc/init.d/saslauthd restart</code></pre>


<p><strong>5. 设置Courier使其支持MySql</strong>
编辑/etc/courier/authdaemonrc文件修改authmodulelist选项值为authmysql</p>

<pre><code>....
authmodulelist="authmysql"
....</code></pre>


<p>编辑/etc/courier/authmysqlrc文件如下</p>

<pre><code>MYSQL_SERVER localhost
MYSQL_USERNAME mail_admin
MYSQL_PASSWORD mail_admin_password
MYSQL_PORT 0
MYSQL_DATABASE mail
MYSQL_USER_TABLE users
MYSQL_CRYPT_PWFIELD password
MYSQL_UID_FIELD 5000
MYSQL_GID_FIELD 5000
MYSQL_LOGIN_FIELD email
MYSQL_HOME_FIELD "/home/vmail"
MYSQL_MAILDIR_FIELD CONCAT(SUBSTRING_INDEX(email,'@',-1),'/',SUBSTRING_INDEX(email,'@',1),'/')</code></pre>


<p>删除Courier创建的证书</p>

<pre><code>$rm -f /etc/courier/imapd.pem
$rm -f /etc/courier/pop3d.pem</code></pre>


<p>分别编辑/etc/courier/imapd.cnf和/etc/courier/pop3d.cnf, 将其中的CN=localhost选项修改为上述中提到的system mail name, 其他选项可以根据需要自行修改, 最后重新生成Courier证书并重启服务</p>

<pre><code>$cd /etc/courier
$mkimapdcert
$mkpop3dcert
$/etc/init.d/courier-authdaemon restart
$/etc/init.d/courier-imap restart
$/etc/init.d/courier-imap-ssl restart
$/etc/init.d/courier-pop restart
$/etc/init.d/courier-pop-ssl restart</code></pre>


<p>这时就可以用telnet来测试一下POP3服务是否正常工作</p>

<pre><code>$telnet localhost pop3
#你将看到如下字样
Trying 127.0.0.1...
Connected to localhost.localdomain.
Escape character is '^]'.
+OK Hello there.</code></pre>


<p><strong>6. 设置Email别名</strong>
编辑别名配置文件
$vim /etc/aliases
postmaster: root
root: post@raecoo.com
更新文件并重启服务</p>

<pre><code>$newaliases
$/etc/init.d/postfix restart</code></pre>


<p><strong>7. 测试Postfix安装结果</strong></p>

<pre><code>$telnet localhost 25
#连接后输入
ehlo localhost
#将看到如下信息
Trying 127.0.0.1...
Connected to localhost.localdomain.
Escape character is '^]'.
220 mail.raecoo.com ESMTP Postfix
ehlo localhost
250-archimedes.palegray.net
250-PIPELINING
250-SIZE 30720000
250-VRFY
250-ETRN
250-STARTTLS
250-AUTH CRAM-MD5 NTLM PLAIN LOGIN DIGEST-MD5
250-AUTH=CRAM-MD5 NTLM PLAIN LOGIN DIGEST-MD5
250-ENHANCEDSTATUSCODES
250-8BITMIME
250 DSN</code></pre>


<p><strong>8. 最后就是添加虚拟域和用户数据了</strong></p>

<pre><code>$mysql -u root -p
mysql>use mail_system;
mysql>INSERT INTO domains (domain) VALUES ('raecoo.com');
mysql>INSERT INTO users (email, password) VALUES ('sales@raecoo.com', ENCRYPT('password'));</code></pre>


<p>现在来测试一下邮件发送</p>

<pre><code>#安装一个命令行的邮件发送工具
apt-get install mailx
echo "email body" > /tmp/email_test.txt
mailx -s "email subject" sales@raecoo.com < /tmp/email_test.txt</code></pre>


<p>嗯,现在就可以用客户端连接POP3邮箱进行邮件查收了.</p>

<p>这里有一个需要注意的地方就是, 当新创建一个虚拟用户后,该用户收件箱对应的文件夹并不会自动创建. 解决这个问题的方法就是在创建用户后先向此用户发送一个Say Hello的邮件.
还有就是虚拟域的文件夹也是需要提前创建好的, 否则在用户使用POP3登录认证时会发生找不到文件目录的错误.
例如添加了虚拟域raecoo.com, 那就需要在/home/vmail下创建一个名为raecoo.com的目录
References:
http://www.howtoforge.com/virtual-users-domains-postfix-courier-mysql-squirrelmail-ubuntu8.10
https://help.ubuntu.com/community/PostfixBasicSetupHowto
https://help.ubuntu.com/community/Postfix</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Raecoo Cao</span></span>

      








  


<time datetime="2009-12-09T00:00:00+08:00" pubdate data-updated="true">Dec 9<span>th</span>, 2009</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://raecoo.github.com/blog/2009/12/09/using-postfix-with-courier-and-mysql-on-debian/" data-via="" data-counturl="http://raecoo.github.com/blog/2009/12/09/using-postfix-with-courier-and-mysql-on-debian/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2009/12/04/use-960-gs-on-rails-application/" title="Previous Post: 在Rails应用中使用960.gs CSS框架">&laquo; 在Rails应用中使用960.gs CSS框架</a>
      
      
        <a class="basic-alignment right" href="/blog/2009/12/18/authlogic-validates-message-i18n/" title="Next Post: Translates Authlogic validates message">Translates Authlogic validates message &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2010/05/30/migration-blog-to-jekyll-and-heroku/">Migration Blog to Jekyll and Heroku</a>
      </li>
    
      <li class="post">
        <a href="/blog/2010/05/29/code-highlight-test/">Code Highlight Test</a>
      </li>
    
      <li class="post">
        <a href="/blog/2010/05/21/dont-forget-the-id-column-in-query-with-select-option/">Don't forget the id column in query with select option</a>
      </li>
    
      <li class="post">
        <a href="/blog/2010/05/08/install-ruby-oci8-on-snow-leopard/">install ruby-oci8 on snow leopard</a>
      </li>
    
      <li class="post">
        <a href="/blog/2010/04/26/string-truncate-in-php/">String truncate in PHP</a>
      </li>
    
  </ul>
</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Raecoo Cao -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'raecoosblog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
